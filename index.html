const SPREADSHEET_ID = '1caeGLL2XixEvjXf6HbpG6R8P7ri0TK5qhSRK1loijJ0';

/**
 * GET para teste simples
 */
function doGet() {
  return ContentService
    .createTextOutput('Web App ativo para Contagem de Material (SALÃO).')
    .setMimeType(ContentService.MimeType.TEXT);
}

/**
 * POST – Recebe dados do formulário e grava na aba correspondente
 */
function doPost(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      throw new Error('Nenhum dado recebido.');
    }

    const data = JSON.parse(e.postData.contents);

    if (!data.unidade) {
      throw new Error('Campo "unidade" não informado.');
    }

    // Define nome da aba com base na unidade
    const abaDestino = data.unidade.trim().toUpperCase() + ' SALÃO';

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(abaDestino);
    if (!sheet) throw new Error(`Aba "${abaDestino}" não encontrada.`);

    // Cabeçalho existente
    let lastCol = sheet.getLastColumn();
    if (lastCol < 1) lastCol = 1;

    let headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
    if (headers[0] === '') headers = [];

    const keys = Object.keys(data);
    let updatedHeaders = false;

    // Garante que todos os campos existam no cabeçalho
    keys.forEach(key => {
      if (!headers.includes(key)) {
        headers.push(key);
        updatedHeaders = true;
      }
    });

    // Atualiza cabeçalho se houve mudança
    if (updatedHeaders) {
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    }

    // Monta a nova linha
    const row = new Array(headers.length).fill('');
    keys.forEach(key => {
      const idx = headers.indexOf(key);
      if (idx > -1) row[idx] = data[key];
    });

    sheet.appendRow(row);

    return ContentService.createTextOutput(
      JSON.stringify({ status: 'success', message: 'Dados salvos com sucesso.' })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(
      JSON.stringify({ status: 'error', message: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}
