const SPREADSHEET_ID = '1caeGLL2XixEvjXf6HbpG6R8P7ri0TK5qhSRK1loijJ0';

/**
 * GET – para testes
 */
function doGet() {
  return ContentService
    .createTextOutput('✅ Web App ativo para Contagem de Material.')
    .setMimeType(ContentService.MimeType.TEXT);
}

/**
 * POST – recebe JSON do formulário e grava na aba correta
 */
function doPost(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      throw new Error('❌ Nenhum dado recebido.');
    }

    const data = JSON.parse(e.postData.contents);
    const unidade = data.unidade;

    if (!unidade) throw new Error('❌ Campo "unidade" não informado.');
    const aba = `${unidade} SALÃO`;

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(aba);
    if (!sheet) throw new Error(`❌ Aba "${aba}" não encontrada.`);

    // Cabeçalho atual
    let headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    if (!headers || headers.length === 0 || headers[0] === '') headers = [];

    const keys = Object.keys(data);
    let updated = false;

    // Atualiza cabeçalho com novas colunas
    keys.forEach(key => {
      if (!headers.includes(key)) {
        headers.push(key);
        updated = true;
      }
    });

    if (updated) {
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    }

    // Preencher linha nova
    const row = headers.map(h => data[h] || '');
    sheet.appendRow(row);

    return ContentService
      .createTextOutput(JSON.stringify({ status: 'success' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        status: 'error',
        message: error.message
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
